#!/bin/sh

. ../script/lib.sh



PackageBuildDependencies()
{
	printf '
linux-headers
make
';
}


PackageRuntimeDependencies()
{
	return 0;
}


PackageWarnings()
{
	printf 'alsa-lib 1.2.10 build fails if we force LTO. But it seems to build fine with -flto-partition=none. And we are currently applying a patch (move.string.macro.patch) that was commited upstream and should no longer be needed after v1.2.10';
	
}


PackageBuild()
{
	local buildDir="$1";
	local prefix="$2";
	local destDir="$3";
	#local npp="$4";
	local dirBin="$5";
	local dirRoot="$6";
	
	local package='alsa-lib';

	local sourceDir;
	sourceDir=$(./latest.sh \
		--package="$package" \
		--url='https://www.alsa-project.org/files/pub/lib' \
		-b="$buildDir"
		);

	if [ -z "$sourceDir" ]; then
		Die 'unable to download the latest source code';
	fi

	DieIfFails ./patch.sh "$package" "$sourceDir";

	
	CC="${dirBin}/cc-lto.partition.none" DieIfFails ./make.sh \
		-b="$buildDir" \
		-s="$sourceDir" \
		--configure-options="\
			--prefix=$prefix \
			--disable-debug \
			--without-debug \
			--without-versioned \
			" \
		--dest-dir="$destDir" \
		--install-options="install-strip";

	local pkgconfigDir="$dirBin/pkgconfig";

	DieIfFails ./adjust-pkgconfig.sh \
		-p="alsa" \
		-d="$destDir" \
		--prefix="$prefix" \
		-o="$pkgconfigDir" \
		-r="$dirRoot";

}
