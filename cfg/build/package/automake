#!/bin/sh

source script.lib.sh

source ../script/build-gnu.sh
source ../script/env.sh


PackageBuildDependencies()
{
	printf '
autoconf
make 
perl';
}


PackagePostBuild()
{	
	Log 'Post build...';
	
	local prefix="$1";
	local destDir="$2";
	local binDir="$3";
	local envVarsFile="$4";
	local rootDir="$5";

	Prepend()
	{
		local path="$1";
		local vars="$2";
		
		if [ -n "$path" ]; then
			for v in $vars; do
				EnvPathPrepend "$envVarsFile" "$v" "$path";
			done;
		fi;
	}

	# export these env vars so other packages can use automake's perl stuff. But
	# only do it if it hasn't been done yet
	if EnvAddPackage "$envVarsFile" 'automake'; then
		local path=$(find "${rootDir}${prefix}/share/" -maxdepth 1 -mindepth 1 -name 'automake-*' -type d );
		Prepend "$path" 'PERL5LIB AUTOMAKE_LIBDIR';

		local path=$(find "${rootDir}${prefix}/share/" -maxdepth 1 -mindepth 1 -name 'automake' -type d );			
		Prepend "$path" 'PERL5LIB AUTOMAKE_LIBDIR';

		path=$(find "${rootDir}${prefix}/share/" -maxdepth 1 -mindepth 1 -name 'aclocal-*' -type d );
		Prepend "$path" 'ACLOCAL_PATH';
		path=$(find "${rootDir}${prefix}/share/" -maxdepth 1 -mindepth 1 -name 'aclocal' -type d );
		Prepend "$path" 'ACLOCAL_PATH';
	fi	
	
	# edit the paths in aclocal and automake and put it in our bin dir, so when 
	# other packages use them, they will search for stuff inside our work dir
	for f in aclocal automake; do
		local destFile="${binDir}/${f}";
		DieIfFails sed "s;'$prefix;'${rootDir}${prefix};" "${destDir}${prefix}/bin/${f}" > "$destFile";
		DieIfFails chmod +x "$destFile";
	done;
}


PackageBuild()
{
	BuildGNU 'automake' "$1" "$2" "$3";	
}
